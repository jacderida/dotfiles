#!/usr/bin/env bash

function init_directories
{
    if [ ! -d "$HOME/.vim/colors" ]; then
        mkdir -p ~/.vim/colors
    fi
    if [ ! -d "$HOME/.vim/syntax" ]; then
        mkdir -p ~/.vim/syntax
    fi
    if [ ! -d "$HOME/.vim/autoload" ]; then
        mkdir -p ~/.vim/autoload
    fi
    if [ ! -d "$HOME/.vim/bundle" ]; then
        mkdir -p ~/.vim/bundle
    fi
    if [ ! -d "$HOME/.vim/backup" ]; then
        mkdir -p ~/.vim/backup
    fi
    if [ ! -d "$HOME/.vim/tmp" ]; then
        mkdir -p ~/.vim/tmp
    fi
}

function install_vundle_plugin
{
    if [ ! -d "$HOME/.vim/bundle/Vundle.vim" ]
    then
        git clone https://github.com/gmarik/Vundle.vim.git ~/.vim/bundle/Vundle.vim
    else
        echo -e "${green}Already installed vundle${nc}"
    fi
}

function download_libclang()
{
    local present_path=$(pwd)
    local destination=$1
    if [ -d $destination ]; then
        rm -rf $destination
    fi
    mkdir -p $destination
    cd "/tmp"
    case $(uname -a) in
        *Ubuntu*)
            curl -O http://llvm.org/releases/3.4.1/clang+llvm-3.4.1-x86_64-unknown-ubuntu12.04.tar.xz
            tar xvf clang+llvm-3.4.1-x86_64-unknown-ubuntu12.04.tar.xz
            cp -r /tmp/clang+llvm-3.4.1-x86_64-unknown-ubuntu12.04/** $destination
            rm -f clang+llvm-3.4.1-x86_64-unknown-ubuntu12.04.tar.xz
            rm -rf clang+llvm-3.4.1-x86_64-unknown-ubuntu12.04
            ;;
        *)
            echo "Setting up dependencies for YouCompleteMe: Unsupported OS encountered. Update get_libclang to support the current OS."
            exit 1
    esac
    cd $present_path
}

function install_cmake()
{
    case $(uname -a) in
        *Ubuntu*)
            sudo apt-get install -y python-dev
            sudo apt-get install -y cmake
            ;;
        *)
            echo "Setting up dependencies for YouCompleteMe: Unsupported OS encountered. Update install_cmake to support the current OS."
            exit 1
    esac
}

function setup_you_complete_me()
{
    install_cmake
    local libclang_path="/tmp/libclang"
    local you_complete_me_path=$HOME/.vim/bundle/YouCompleteMe
    download_libclang $libclang_path
    local present_path=$(pwd)
    local ycm_build_path="$HOME/dev/ycm_build"
    mkdir -p $ycm_build_path
    cd $ycm_build_path
    cmake -G "Unix Makefiles" -DPATH_TO_LLVM_ROOT=$libclang_path . $you_complete_me_path/third_party/ycmd/cpp
    make ycm_support_libs
    cd $present_path
}

function install_manual_plugins
{
    for plugin in `find ./vim/plugins -maxdepth 1 -type d`
    do
        echo -e "${green}Installing manual plugin $plugin ${nc}"
        cp -r $plugin/* ~/.vim
    done
}

function install_bundler_plugin
{
    if [ ! -d "$HOME/.vim/bundle/vim-bundler" ]
    then
        git clone https://github.com/tpope/vim-bundler.git ~/.vim/bundle/vim-bundler
    else
        echo -e "${green}Already installed vim-bundler${nc}"
    fi
}

function setup_command_t_plugin
{
    present_directory=`pwd`
    cd ~/.vim/bundle/Command-T/ruby/command-t
    if [[ $(uname -s) != CYGWIN_NT-* ]]; then
        [[ -s "$HOME/.rvm/scripts/rvm" ]] && source "$HOME/.rvm/scripts/rvm"
        rvm use 1.8.7
    fi
    ruby extconf.rb
    if [[ $(uname -s) = CYGWIN_NT-* ]]; then
        # On Cygwin, replace
        # CFLAGS += -Wall -Wextra -Wno-unused-parameter
        # with
        # CFLAGS += -Wextra -Wno-unused-parameter
        # This switches off all warnings as errors. For some reason, on Cygwin, there's a weird 64 bit integer
        # warning that prevents successful compilation.
        sed -i 's/^CFLAGS +=.*/CFLAGS += -Wextra -Wno-unused-parameter/g' Makefile
    fi
    make
    cd $present_directory
}

function install_asynccommand_plugin
{
    if [ ! -d "$HOME/.vim/bundle/AsyncCommand" ]
    then
        echo -e "${green}Installing AsyncCommand plugin${nc}"
        git clone https://github.com/pydave/AsyncCommand.git ~/.vim/bundle/AsyncCommand
    else
        echo -e "${green}Already installed AsyncCommand${nc}"
    fi
}

function install_vjde_plugin
{
    if [ ! -d "$HOME/.vim/bundle/vjde" ]
    then
        echo -e "${green}Installing vjde plugin${nc}"
        git clone https://github.com/cespare/vjde.git ~/.vim/bundle/vjde
    else
        echo -e "${green}Already installed vjde${nc}"
    fi
}

function install_supertab
{
    if [ ! -d "$HOME/.vim/bundle/supertab" ]
    then
        echo -e "${green}Installing supertab plugin${nc}"
        git clone https://github.com/ervandew/supertab.git ~/.vim/bundle/supertab
    else
        echo -e "${green}Already installed supertab${nc}"
    fi
}

function install_jedi
{
    if [ ! -d "$HOME/.vim/bundle/jedi-vim" ]
    then
        echo -e "${green}Installing jedi-vim plugin${nc}"
        pip install jedi
        git clone https://github.com/davidhalter/jedi-vim.git ~/.vim/bundle/jedi-vim
    else
        echo -e "${green}Already installed jedi-vim plugin${nc}"
    fi
}

function install_tmux_navigator
{
    if [ ! -d "$HOME/.vim/bundle/vim-tmux-navigator" ]
    then
        echo -e "${green}Installing tmux navigator plugin${nc}"
        git clone https://github.com/christoomey/vim-tmux-navigator.git ~/.vim/bundle/vim-tmux-navigator
    else
        echo -e "${green}Already installed tmux navigator plugin${nc}"
    fi
}

function install_easymotion
{
    if [ ! -d "$HOME/.vim/bundle/vim-easymotion" ]
    then
        echo -e "${green}Installing easy motion plugin${nc}"
        git clone https://github.com/Lokaltog/vim-easymotion.git ~/.vim/bundle/vim-easymotion
    else
        echo -e "${green}Already installed easy motion plugin${nc}"
    fi
}

function install_xml
{
    if [ ! -d "$HOME/.vim/bundle/xmledit" ]
    then
        echo -e "${green}Installing xmledit plugin${nc}"
        git clone https://github.com/sukima/xmledit.git ~/.vim/bundle/xmledit
    else
        echo -e "${green}Already installed xmledit plugin${nc}"
    fi
}

function install_plugins
{
    install_manual_plugins
    install_vundle_plugin
    install_bundler_plugin
    install_tmux_navigator
    install_easymotion
    install_xml
}

function install_files
{
    echo -e "${green}Removing .vimrc and linking from dotfiles${nc}"
    rm -f ~/.vimrc
    ln -f ./vim/.vimrc ~/.vimrc
    echo -e "${green}Installing vim colours from dotfiles${nc}"
    cp ./vim/colors/*.* ~/.vim/colors
    echo -e "${green}Installing pathogen from dotfiles${nc}"
    cp ./vim/pathogen.vim ~/.vim/autoload
    cp ./vim/sh.vim ~/.vim/syntax
}

init_directories
install_files
install_vundle_plugin
vim +PluginInstall +qall
setup_command_t_plugin
setup_you_complete_me
install_plugins
